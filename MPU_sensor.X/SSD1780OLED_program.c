/* 
 * File:   SSD17890OLED.c
 * Author: Mohamed
 *
 * Created on November 22, 2023, 3:19 PM
 */
#include"configure.h"
#include"SSD1780OLED_config.h"
#include"SSD1780OLED_interface.h"

// the size of screen is 128*64 
// to fill the screen you need 1024 loop

rom const char Font[] = {
0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x5F, 0x00, 0x00,
0x00, 0x07, 0x00, 0x07, 0x00,
0x14, 0x7F, 0x14, 0x7F, 0x14,
0x24, 0x2A, 0x7F, 0x2A, 0x12,
0x23, 0x13, 0x08, 0x64, 0x62,
0x36, 0x49, 0x56, 0x20, 0x50,
0x00, 0x08, 0x07, 0x03, 0x00,
0x00, 0x1C, 0x22, 0x41, 0x00,
0x00, 0x41, 0x22, 0x1C, 0x00,
0x2A, 0x1C, 0x7F, 0x1C, 0x2A,
0x08, 0x08, 0x3E, 0x08, 0x08,
0x00, 0x80, 0x70, 0x30, 0x00,
0x08, 0x08, 0x08, 0x08, 0x08,
0x00, 0x00, 0x60, 0x60, 0x00,
0x20, 0x10, 0x08, 0x04, 0x02,
0x3E, 0x51, 0x49, 0x45, 0x3E,
0x00, 0x42, 0x7F, 0x40, 0x00,
0x72, 0x49, 0x49, 0x49, 0x46,
0x21, 0x41, 0x49, 0x4D, 0x33,
0x18, 0x14, 0x12, 0x7F, 0x10,
0x27, 0x45, 0x45, 0x45, 0x39,
0x3C, 0x4A, 0x49, 0x49, 0x31,
0x41, 0x21, 0x11, 0x09, 0x07,
0x36, 0x49, 0x49, 0x49, 0x36,
0x46, 0x49, 0x49, 0x29, 0x1E,
0x00, 0x00, 0x14, 0x00, 0x00,
0x00, 0x40, 0x34, 0x00, 0x00,
0x00, 0x08, 0x14, 0x22, 0x41,
0x14, 0x14, 0x14, 0x14, 0x14,
0x00, 0x41, 0x22, 0x14, 0x08,
0x02, 0x01, 0x59, 0x09, 0x06,
0x3E, 0x41, 0x5D, 0x59, 0x4E,
0x7C, 0x12, 0x11, 0x12, 0x7C,
0x7F, 0x49, 0x49, 0x49, 0x36,
0x3E, 0x41, 0x41, 0x41, 0x22,
0x7F, 0x41, 0x41, 0x41, 0x3E,
0x7F, 0x49, 0x49, 0x49, 0x41,
0x7F, 0x09, 0x09, 0x09, 0x01,
0x3E, 0x41, 0x41, 0x51, 0x73,
0x7F, 0x08, 0x08, 0x08, 0x7F,
0x00, 0x41, 0x7F, 0x41, 0x00,
0x20, 0x40, 0x41, 0x3F, 0x01,
0x7F, 0x08, 0x14, 0x22, 0x41,
0x7F, 0x40, 0x40, 0x40, 0x40,
0x7F, 0x02, 0x1C, 0x02, 0x7F,
0x7F, 0x04, 0x08, 0x10, 0x7F,
0x3E, 0x41, 0x41, 0x41, 0x3E,
0x7F, 0x09, 0x09, 0x09, 0x06,
0x3E, 0x41, 0x51, 0x21, 0x5E,
0x7F, 0x09, 0x19, 0x29, 0x46
};
rom const char Font2[] = {
0x26, 0x49, 0x49, 0x49, 0x32,
0x03, 0x01, 0x7F, 0x01, 0x03,
0x3F, 0x40, 0x40, 0x40, 0x3F,
0x1F, 0x20, 0x40, 0x20, 0x1F,
0x3F, 0x40, 0x38, 0x40, 0x3F,
0x63, 0x14, 0x08, 0x14, 0x63,
0x03, 0x04, 0x78, 0x04, 0x03,
0x61, 0x59, 0x49, 0x4D, 0x43,
0x00, 0x7F, 0x41, 0x41, 0x41,
0x02, 0x04, 0x08, 0x10, 0x20,
0x00, 0x41, 0x41, 0x41, 0x7F,
0x04, 0x02, 0x01, 0x02, 0x04,
0x40, 0x40, 0x40, 0x40, 0x40,
0x00, 0x03, 0x07, 0x08, 0x00,
0x20, 0x54, 0x54, 0x78, 0x40,
0x7F, 0x28, 0x44, 0x44, 0x38,
0x38, 0x44, 0x44, 0x44, 0x28,
0x38, 0x44, 0x44, 0x28, 0x7F,
0x38, 0x54, 0x54, 0x54, 0x18,
0x00, 0x08, 0x7E, 0x09, 0x02,
0x18, 0xA4, 0xA4, 0x9C, 0x78,
0x7F, 0x08, 0x04, 0x04, 0x78,
0x00, 0x44, 0x7D, 0x40, 0x00,
0x20, 0x40, 0x40, 0x3D, 0x00,
0x7F, 0x10, 0x28, 0x44, 0x00,
0x00, 0x41, 0x7F, 0x40, 0x00,
0x7C, 0x04, 0x78, 0x04, 0x78,
0x7C, 0x08, 0x04, 0x04, 0x78,
0x38, 0x44, 0x44, 0x44, 0x38,
0xFC, 0x18, 0x24, 0x24, 0x18,
0x18, 0x24, 0x24, 0x18, 0xFC,
0x7C, 0x08, 0x04, 0x04, 0x08,
0x48, 0x54, 0x54, 0x54, 0x24,
0x04, 0x04, 0x3F, 0x44, 0x24,
0x3C, 0x40, 0x40, 0x20, 0x7C,
0x1C, 0x20, 0x40, 0x20, 0x1C,
0x3C, 0x40, 0x30, 0x40, 0x3C,
0x44, 0x28, 0x10, 0x28, 0x44,
0x4C, 0x90, 0x90, 0x90, 0x7C,
0x44, 0x64, 0x54, 0x4C, 0x44,
0x00, 0x08, 0x36, 0x41, 0x00,
0x00, 0x00, 0x77, 0x00, 0x00,
0x00, 0x41, 0x36, 0x08, 0x00,
0x02, 0x01, 0x02, 0x04, 0x02
};

static uint8_t SSD1780OLED_buffer[SSD1780OLED_LCDHEIGHT * SSD1780OLED_LCDWIDTH / 8];

#inline 
uint8_t VOledSend(uint8_t ucSendByte,SendByte_T xByteType)
{
    i2c_start();
    i2c_write(SSD1780OLED_Adress);
    
    if(xByteType == SendData)
    {
        //i2c_write( ((long)SSD1780OLED_ControlByteData<<6) | 0x00);
        i2c_write(0b01000000);
    }
    else
    {
        //i2c_write( ((long)SSD1780OLED_ControlByteCommand<<6) | 0x00);
         i2c_write(0x00);
    }
    
    uint8_t ucError  = i2c_write(ucSendByte); 
    i2c_stop();
    return ucError;    
}

uint8_t VOledSendCommand(uint8_t ucCommand)
{
    return VOledSend(ucCommand,SendCommand);
}
void VOledSendData(uint8_t ucData)
{

    VOledSend(ucData,SendData);

}

void VOledSetAddressingMode(OledScreenAdressing_T xScreenAdressing)
{
    switch(xScreenAdressing)
    {
        case PageAddressing:
            VOledSendCommand(0x20);
            VOledSendCommand(0xA0);
            break;
        case HorizontalAddressing:
            VOledSendCommand(0x20);
            VOledSendCommand(0xA0);
            break;
        case VerticalAddressing:
            VOledSendCommand(0x20);
            VOledSendCommand(0xA0);
            break;
    }
}

void VOledInit()
{
    VOledSendCommand(SSD1780OLED_SetMultiplexRatio);   
    VOledSendCommand(0x3F); // 63   

    VOledSendCommand(SSD1780OLED_SetDisplayOffset);   
    VOledSendCommand(0x00);   

    VOledSendCommand(SSD1780OLED_SetDisplayStartLine);

    VOledSendCommand(SSD1780OLED_SetSegmentRemap);
        
    VOledSendCommand(SSD1780OLED_SetCOMOutputScanDirection);
    
    VOledSendCommand(SSD1780OLED_SetCOMPinsHardwareConfiguration);   
    VOledSendCommand(0x12);   
 
    VOledSendCommand(SSD1780OLED_SetContrastControl);   
    VOledSendCommand(0x7F);   

    VOledSendCommand(SSD1780OLED_EntireDisplayON);   

    VOledSendCommand(SSD1780OLED_SetNormalDisplayMode);   

 
    VOledSendCommand(SSD1780OLED_SetDisplayClockDivideRatio);   
    VOledSendCommand(0x80);   

    
    VOledSendCommand(SSD1780OLED_EnableChargePumpRegulator);   
    VOledSendCommand(0x14);   
    
    VOledSendCommand(SSD1780OLED_DisplayON);  
    
    VOledSetAddressingMode(HorizontalAddressing);
}



void VOledSetAddressSpace(
                    uint16_t usColumnAddressStart,uint16_t usColumnAddressEnd,
                    uint16_t usPageAddressStart,uint16_t usPageAddressEnd)
{
    
    VOledSendCommand(SSD1780OLED_SetColumnAddress);
    VOledSendCommand(usColumnAddressStart);
    VOledSendCommand(usColumnAddressEnd);

    VOledSendCommand(SSD1780OLED_SetPageAddress);
    VOledSendCommand(usPageAddressStart);
    VOledSendCommand(usPageAddressEnd);
    
}

void VOledDrawPixel(uint8_t x, uint8_t y,uint8_t ucColor)
{
  if ((x >= SSD1780OLED_LCDWIDTH) || (y >= SSD1780OLED_LCDHEIGHT))
    return;
  if (ucColor)
    SSD1780OLED_buffer[x + (uint16_t)(y / 8) * SSD1780OLED_LCDWIDTH] |=  (1 << (y & 7));
  else
    SSD1780OLED_buffer[x + (uint16_t)(y / 8) * SSD1780OLED_LCDWIDTH] &=  ~(1 << (y & 7));
  
}
void VOledDisplay()
{
    VOledSetAddressSpace(0,127,0,7);
    for(uint32_t y = 0 ;y<(SSD1780OLED_LCDWIDTH*SSD1780OLED_LCDHEIGHT / 8);y++)
    {
        VOledSendData(SSD1780OLED_buffer[y]);
    }
       
}

void VOledFillScreen(uint8_t ucColor)
{
    if(ucColor == 0)
    {
        for(uint32_t y = 0 ;y<(SSD1780OLED_LCDWIDTH*SSD1780OLED_LCDHEIGHT / 8);y++)
        {
        SSD1780OLED_buffer[y] = 0x00;
        }    
    
    }
    else
    {
        for(uint32_t y = 0 ;y<(SSD1780OLED_LCDWIDTH*SSD1780OLED_LCDHEIGHT / 8);y++)
        {
        SSD1780OLED_buffer[y] = 0xFF;
        }    
    }
    
}


void VOled_DrawChar(uint16_t x, uint16_t y, uint8_t c, uint8_t size = 1)
{
  //SSD1306_TextSize(size);
  //VOled_Print(c);
uint8_t i, j, line;    

for(i = 0; i < 5; i++ ) 
    {
        if(c < 'S')
          line = Font[(c - ' ') * 5 + i];
        else
          line = Font2[(c - 'S') * 5 + i];

        for(j = 0; j < 7; j++, line >>= 1) {
          if(line & 0x01)
          {
              VOledDrawPixel(x+i, y+j,0xFF);
          }
          else
          {
              VOledDrawPixel(x+i, y+j,0x00);
          }
        }
    }
 
}

// no font size scaling 
void VOled_DrawCharFast(uint16_t x, uint16_t y, uint8_t c)
{
if ((x >= SSD1780OLED_LCDWIDTH) || (y >= SSD1780OLED_LCDHEIGHT))
return;

 uint8_t i, j, line;    
    for(i = 0; i < 5; i++ ) 
    {
        if(c < 'S')
          line = Font[(c - ' ') * 5 + i];
        else
          line = Font2[(c - 'S') * 5 + i];
          
        SSD1780OLED_buffer[x+i + (uint16_t)((y+j) / 8) * SSD1780OLED_LCDWIDTH] = line;   
    }
     
}
#inline 
void VOled_DrawStringFast(uint16_t x, uint16_t y, uint8_t* ptrString)
{
    uint16_t uscount = 0;
    while(ptrString[uscount] != '\0')
    {
        VOled_DrawCharFast(x,y,ptrString[uscount]);
        uscount++;
        x=(uscount*5);
        if(x >= 127)
        {
            y +=7;
            x = 0;
        }
    }
}

void VOled_Print(uint16_t x, uint16_t y, uint8_t* ptrString, uint8_t size = 1)
{
    if(size == 1)
    {
        VOled_DrawStringFast(x,y,ptrString);
    }
}



void VOled_writeLine(int16_t x0, int16_t y0, int16_t x1, int16_t y1,
                             uint16_t color) {

  int16_t steep = abs(y1 - y0) > abs(x1 - x0);
  if (steep) {
    int16_t temp = x0;
    x0 = y0;
    y0 = temp;
    
    temp = x1;
    x1 = y1;
    y1 = temp;

  }

  if (x0 > x1) {
      
     int16_t temp = x0;
    x0 = x1;
    x1 = temp;
    
    temp = y0;
    y0 = y1;
    y1 = temp;
  }

  int16_t dx, dy;
  dx = x1 - x0;
  dy = abs(y1 - y0);

  int16_t err = dx / 2;
  int16_t ystep;

  if (y0 < y1) {
    ystep = 1;
  } else {
    ystep = -1;
  }

  for (; x0 <= x1; x0++) {
    if (steep) {
      VOledDrawPixel(y0, x0, color);
    } else {
      VOledDrawPixel(x0, y0, color);
    }
    err -= dy;
    if (err < 0) {
      y0 += ystep;
      err += dx;
    }
  }
}
void VOledFillRect(int16_t x0, int16_t y0, int16_t x1, int16_t y1,
        uint8_t ucColor)
{

for (x0 ; (x0 < x1) || (y0 >= SSD1780OLED_LCDWIDTH) ; x0++)
{
    
    for (y0 ; (y0 < y1) || (y0 >= SSD1780OLED_LCDWIDTH) ;y0++)
    {
        VOledDrawPixel(x0,y0,ucColor);
    }    
}

}